function EventBuilder(n,s){this._pageUuid=n.generateUUID(),this._appName=s.getAppName(),this._platform=s.getPlatform(),this._userId=null,this._getDefaultProperties=function(t){return{app_name:this._appName,login:""!==this._userId&&null!==this._userId&&void 0!==this._userId,platform:this._platform,uuid:this._pageUuid,falcon_version:t}},this.construct=function(t){this._userId=s.getLoggedInUserId(this._appName);var e=n.generateUUID(),i=this._getDefaultProperties(t.falcon_version);return properties=n.extend(i,t.properties),{id:e,visit_token:t.visit_token,visitor_token:t.visitor_token,user_id:this._userId,name:t.name,properties:properties,time:(new Date).getTime()/1e3}}}function VisitBuilder(t){this._appName=t.getAppName(),this._userId=t.getLoggedInUserId(this._appName),this._platform=t.getPlatform(),this.construct=function(t){return{visit_token:t.visit_token,visitor_token:t.visitor_token,user_id:this._userId,app_name:this._appName,platform:this._platform,landing_page:window.location.href,screen_width:window.screen.width,screen_height:window.screen.height,referrer:0<document.referrer.length?document.referrer:void 0,falcon_version:t.falcon_version}}}var eventStorage,visitStorage,AhoyConfigFactory=function(){window.ahoyUserDefinedConfig=window.ahoyUserDefinedConfig||{};var e={};return e.visitTtl=window.ahoyUserDefinedConfig.visitTtl||30,e.visitorTtl=window.ahoyUserDefinedConfig.visitorTtl||1051200,e.cookieSizeLimit=window.ahoyUserDefinedConfig.cookieSizeLimit||3e3,e.batchInterval=window.ahoyUserDefinedConfig.batchInterval||3e3,e.userId=window.ahoyUserDefinedConfig.userId||void 0,e.appName=window.ahoyUserDefinedConfig.appName||void 0,e.page=window.location.pathname,e.hostname=window.location.hostname,e.plentyHostname={production:"https://plenty.analisis.io",staging:"https://staging-plenty.analisis.io",development:"http://127.0.0.1:5009"},e.getVisitUrl=function(){return"staging"==e.getEnvironment()?e.plentyHostname.staging+"/ahoy/visits":"production"==e.getEnvironment()?e.plentyHostname.production+"/ahoy/visits":e.plentyHostname.development+"/ahoy/visits"},e.getEventUrl=function(){return"staging"==e.getEnvironment()?e.plentyHostname.staging+"/ahoy/events":"production"==e.getEnvironment()?e.plentyHostname.production+"/ahoy/events":e.plentyHostname.development+"/ahoy/events"},e.getBatchEventUrl=function(){return"staging"==e.getEnvironment()?e.plentyHostname.staging+"/events":"production"==e.getEnvironment()?e.plentyHostname.production+"/events":e.plentyHostname.development+"/events"},e.getEnvironment=function(){var t=e.hostname;return null!=window.ahoyUserDefinedConfig.environment?window.ahoyUserDefinedConfig.environment:0<=t.indexOf("staging")?"staging":/\.?(vidio)\.com$|\.?analisis\.io$/.test(t)?"production":"development"},e.testLocalStorage=function(){try{return window.localStorage.setItem("test",1),window.localStorage.removeItem("test"),!0}catch(t){return!1}},e.isUseLocalStorage=e.testLocalStorage(),e.isSendBatchEvent=e.isUseLocalStorage&&window.ahoyUserDefinedConfig.sendBatch,e.visitsUrl=e.getVisitUrl(),e.eventsUrl=e.getEventUrl(),e.batchEventsUrl=e.getBatchEventUrl(),e};function CookieJar(){this.setData=function(t,e,i){var n,s="";if(i){var o=new Date;o.setTime(o.getTime()+60*i*1e3),s="; expires="+o.toGMTString()}n="; domain="+this.getCookieDomain(),cookie=t+"="+escape(e)+s+n+"; path=/",document.cookie=cookie},this.getData=function(t){for(var e,i=t+"=",n=document.cookie.split(";"),s=0;s<n.length;s++){for(e=n[s];" "===e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(i))return unescape(e.substring(i.length,e.length))}return null},this.deleteData=function(t){var e=document.cookie.split("; ");e=e.filter(function(t){return""!==t});for(var i=0;i<e.length;i++)for(var n=window.location.hostname.split(".");0<n.length;)if(e[i].split(";")[0].split("=")[0]===t){var s=encodeURIComponent(e[i].split(";")[0].split("=")[0])+"=; expires=Thu, 01-Jan-1970 00:00:01 GMT; domain="+n.join(".")+" ;path=",o=location.pathname.split("/");for(document.cookie=s+"/";0<o.length;)document.cookie=s+o.join("/"),o.pop();n.shift()}},this.getCookieDomain=function(){var t=this._getHostname();if(this._isIP(t))return t;var e=t.split(".");return 2<e.length&&(e=e.slice(1)),e.join(".")},this.deleteAhoyCookie=function(){return this.deleteData("ahoy_visit"),this.deleteData("ahoy_visitor"),this.deleteData("ahoy_events"),!0},this.isCookiesEnabled=function(){return this.setData("is_cookie_active","true",5),"true"==this.getData("is_cookie_active")},this._isIP=function(t){var e=t.split(".");return 4==e.length&&e.reduce(function(t,e){return t&&0<=e&&e<256},!0)},this._getHostname=function(){return window.location.hostname}}function Helpers(){this.post=function(t,e,i){var n=new XMLHttpRequest;n.onreadystatechange=function(){4!==n.readyState||200!==n.status&&400!==n.status||i()},n.open("POST",t,!0),n.setRequestHeader("Content-Type","application/json; charset=UTF-8"),n.send(e)},this.extend=function(t){t=t||{};for(var e=1;e<arguments.length;e++){var i=arguments[e];if(i)for(var n in i)i.hasOwnProperty(n)&&("object"==typeof i[n]?t[n]=this.extend(t[n],i[n]):t[n]=i[n])}return t},this.jsonToParams=function(e){return Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")},this.generateUUID=function(){var i=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=(i+16*Math.random())%16|0;return i=Math.floor(i/16),("x"==t?e:3&e|8).toString(16)})},this.isNull=function(t){return null==t}}function LocalJar(){this.setData=function(t,e,i){var n=new Date;i?n.setMinutes(n.getMinutes()+i):n.setFullYear(n.getFullYear()+2),window.localStorage.setItem(t,[e,n])},this.getData=function(t){var e=window.localStorage.getItem(t);if(!e)return null;var i=e.split(","),n=i.splice(i.length-1)[0],s=i.join(",");return new Date>new Date(n)?(this.deleteData(t),null):s},this.deleteData=function(t){return window.localStorage.removeItem(t)}}function Models(){this.getAppName=function(){var t=this.hostname().split(".");return 2<t.length?t.reverse()[1]:t[0]},this.getLoggedInUserId=function(t){var e;return"vidio"===t&&null==(e=this.getUserFromVidioCookie())&&(e=this.getUserFromMeta()),e},this.getUserFromVidioCookie=function(){return(new CookieJar).getData("plenty_id")},this.getUserFromMeta=function(){var t=document.querySelector("meta[name=current-user-id]");if(t)return t.getAttribute("content")},this.getUserFromCookie=function(){var t=(new CookieJar).getData("user");try{return JSON.parse(decodeURIComponent(t)).id}catch(t){}},this.getPlatform=function(){return-1<this.hostname().indexOf("m.vidio.com")?"web-mobile":-1<this.hostname().indexOf("www.vidio.com")?"web-desktop":-1<this.useragent().indexOf("Tizen")?"tv-tizen":"unknown"},this.useragent=function(){return window.navigator.userAgent},this.hostname=function(){return location.hostname}}function Tracker(t,e,i,n,s){this.visitStorage=t,this.eventStorage=e,this.helpers=i,this.models=n,this.config=s,this.batchIntervalId=null,this.visitId=null,this.visitorId=null,this.falconVersion=null,this.isReady=!1,this.queue=[],this.eventQueue=[],this.canStringify="undefined"!=typeof JSON&&void 0!==JSON.stringify,this.visitBuilder=new VisitBuilder(n),this.eventBuilder=new EventBuilder(i,n),this.init=function(){var t=this._documentCurrentScriptSource();this.falconVersion=t?t.substring(t.indexOf("ahoy-"),t.indexOf(".js")):"unknown",this.isVisitIdOrVisitorIdEmpty()?(this.setupVisitIdAndVisitorId(),this.prepareAndSendVisitsData()):(this.refreshVisitId(),this.setReady()),this.consumeAllEventsInQueues()},this.isVisitIdOrVisitorIdEmpty=function(){return this.visitId=this.visitStorage.getData("ahoy_visit")?this.visitStorage.getData("ahoy_visit"):window.ahoyUserDefinedConfig.visitId,this.visitorId=this.visitStorage.getData("ahoy_visitor")?this.visitStorage.getData("ahoy_visitor"):window.ahoyUserDefinedConfig.visitorId,!this.visitId||!this.visitorId},this.setupVisitIdAndVisitorId=function(){this.visitorId||(this.visitorId=this.helpers.generateUUID(),this.visitStorage.setData("ahoy_visitor",this.visitorId,this.config.visitorTtl),window.ahoyUserDefinedConfig.visitorId=this.visitorId,this.visitId=null),this.visitId||this.refreshVisitId()},this.refreshVisitId=function(){this.visitId||(this.visitId=this.helpers.generateUUID()),this.visitStorage.setData("ahoy_visit",this.visitId,this.config.visitTtl),window.ahoyUserDefinedConfig.visitId=this.visitId},this.prepareAndSendVisitsData=function(){var t=this.visitBuilder.construct({visit_token:this.visitId,visitor_token:this.visitorId,falcon_version:this.falconVersion});this.helpers.post(this.config.visitsUrl,JSON.stringify(t),this.setReady)},this.setReady=function(){for(var t=this.queue||window.ahoy.queue,e=t.shift();e;)e(),e=t.shift();this.isReady=!0},this.consumeAllEventsInQueues=function(){try{this.eventQueue=JSON.parse(this.eventStorage.getData("ahoy_events")||"[]")}catch(t){}this.consumeEventQueue(),this.consumeAhoyQueue(),this.visitId=this.visitStorage.getData("ahoy_visit")?this.visitStorage.getData("ahoy_visit"):window.ahoyUserDefinedConfig.visitId},this.consumeEventQueue=function(){if(this.config.isSendBatchEvent)this.trackBatchEvent(),this.batchIntervalId=setInterval(this.trackBatchEvent.bind(this),this.config.batchInterval);else for(var t=0;t<this.eventQueue.length;t++)this.trackEvent(this.eventQueue[t])},this.consumeAhoyQueue=function(){if(void 0!==window.ahoy_q){for(var t=0;t<window.ahoy_q.length;t++){var e=window.ahoy_q[t][0],i=window.ahoy_q[t][1];this.track(e,i)}window.ahoy_q=[]}},this.track=function(t,e){if(this.canStringify){var i=this.eventBuilder.construct({name:t,visit_token:this.visitId,visitor_token:this.visitorId,falcon_version:this.falconVersion,properties:e});this.eventQueue.push(i),this.saveEventQueue(),this.config.isSendBatchEvent||setTimeout(function(){this.trackEvent(i)}.bind(this),500),this.visitStorage.setData("ahoy_visit",this.visitId,this.config.visitTtl),this.isReady=!0}},this.emptyEventQueue=function(){this.eventQueue=[],this.saveEventQueue()},this.trackBatchEvent=function(){0!==this.eventQueue.length&&this.helpers.post(this.config.batchEventsUrl,JSON.stringify(this.eventQueue),this.emptyEventQueue.bind(this))},this.emptySpecificEventQueue=function(t){for(var e=0;e<this.eventQueue.length;e++)if(this.eventQueue[e].id==t.id){this.eventQueue.splice(e,1);break}this.saveEventQueue()},this.trackEvent=function(t){this.isReady?this.helpers.post(this.config.eventsUrl,JSON.stringify(t),this.emptySpecificEventQueue):this.queue.push(this.helpers.post(this.config.eventsUrl,JSON.stringify(t),this.emptySpecificEventQueue))},this.saveEventQueue=function(){this.canStringify&&(this.config.isUseLocalStorage||JSON.stringify(this.eventQueue).length<=this.config.cookieSizeLimit&&this.helpers.jsonToParams(this.eventQueue).length<=this.config.cookieSizeLimit)&&this.eventStorage.setData("ahoy_events",JSON.stringify(this.eventQueue),1)},this._documentCurrentScriptSource=function(){return document.currentScript?document.currentScript.src:null}}var ahoySendBatchEvent=!0,AhoyConfig=new AhoyConfigFactory,helpers=new Helpers,models=new Models;visitStorage=AhoyConfig.isUseLocalStorage?(eventStorage=new LocalJar,new CookieJar):eventStorage=new CookieJar,window.ahoy=new Tracker(visitStorage,eventStorage,helpers,models,AhoyConfig),window.ahoy.init();